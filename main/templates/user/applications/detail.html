{% extends 'user/base.html' %}

{% block title %}{{ application.job.title }} - Application - Talent Solutions{% endblock %}

{% block body_class %}bg-gray-50{% endblock %}
{% block main_class %}min-h-screen pt-20 flex flex-col{% endblock %}

{% block extra_css %}
<style>
    .status-badge-lg {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 18px;
        border-radius: 9999px;
        font-size: 15px;
        font-weight: 600;
    }
    .status-badge-lg .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .status-pending    { background: #fef3c7; color: #92400e; }
    .status-pending .dot    { background: #f59e0b; }
    .status-reviewed   { background: #dbeafe; color: #1e40af; }
    .status-reviewed .dot   { background: #3b82f6; }
    .status-shortlisted { background: #ede9fe; color: #6d28d9; }
    .status-shortlisted .dot { background: #8b5cf6; }
    .status-accepted   { background: #dcfce7; color: #166534; }
    .status-accepted .dot   { background: #22c55e; }
    .status-rejected   { background: #fee2e2; color: #991b1b; }
    .status-rejected .dot   { background: #ef4444; }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-row .label {
        font-size: 14px;
        color: #6b7280;
    }
    .info-row .value {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<section class="bg-white border-b border-gray-100">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <nav class="flex items-center gap-2 text-sm text-gray-500">
            <a href="{% url 'user_my_applications' %}" class="hover:text-cyan-600 transition-colors">My Applications</a>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span class="text-gray-900 font-medium truncate">{{ application.job.title }}</span>
        </nav>
    </div>
</section>

<!-- Content -->
<section class="py-8 sm:py-10 flex-1">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid lg:grid-cols-5 gap-6">

            <!-- Left Column (3/5): Job & Status -->
            <div class="lg:col-span-3 flex flex-col gap-6">

                <!-- Job Info Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <!-- Gradient Header -->
                    <div class="bg-gradient-to-r from-cyan-500 to-blue-600 p-6">
                        <h2 class="text-xl font-bold text-white">{{ application.job.title }}</h2>
                        <p class="text-cyan-100 mt-0.5">{{ application.job.company_name }}</p>
                    </div>
                    <!-- Details -->
                    <div class="p-5">
                        <div class="info-row">
                            <span class="label">Country</span>
                            <span class="value">{{ application.job.get_country_display_name }}</span>
                        </div>
                        {% if application.job.city %}
                        <div class="info-row">
                            <span class="label">City</span>
                            <span class="value">{{ application.job.city }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span class="label">Monthly Salary</span>
                            <span class="value text-green-600">{{ application.job.get_salary_display }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Vacancies</span>
                            <span class="value">{{ application.job.vacancies }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Deadline</span>
                            <span class="value">{{ application.job.deadline|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Application Status</h3>

                    <!-- Status Badge -->
                    <div class="flex items-center justify-between">
                        <span class="status-badge-lg status-{{ application.status }}">
                            <span class="dot"></span>
                            {{ application.get_status_display }}
                        </span>
                        <span class="text-sm text-gray-400">Applied {{ application.created_at_datetime|date:"M d, Y" }}</span>
                    </div>

                    <!-- Status Progress Bar -->
                    <div class="mt-6">
                        <div class="flex items-center">
                            <!-- Pending -->
                            <div class="w-4 h-4 rounded-full bg-cyan-500"></div>
                            <!-- bar -->
                            <div class="flex-1 h-1 mx-1 rounded-full {% if application.status != 'pending' %}bg-cyan-500{% else %}bg-gray-200{% endif %}"></div>
                            <!-- Reviewed -->
                            <div class="w-4 h-4 rounded-full {% if application.status == 'reviewed' or application.status == 'shortlisted' or application.status == 'accepted' or application.status == 'rejected' %}bg-cyan-500{% else %}bg-gray-200{% endif %}"></div>
                            <!-- bar -->
                            <div class="flex-1 h-1 mx-1 rounded-full {% if application.status == 'shortlisted' or application.status == 'accepted' or application.status == 'rejected' %}bg-cyan-500{% else %}bg-gray-200{% endif %}"></div>
                            <!-- Shortlisted -->
                            <div class="w-4 h-4 rounded-full {% if application.status == 'shortlisted' or application.status == 'accepted' or application.status == 'rejected' %}bg-cyan-500{% else %}bg-gray-200{% endif %}"></div>
                            <!-- bar -->
                            <div class="flex-1 h-1 mx-1 rounded-full {% if application.status == 'accepted' or application.status == 'rejected' %}bg-cyan-500{% else %}bg-gray-200{% endif %}"></div>
                            <!-- Decision -->
                            <div class="w-4 h-4 rounded-full {% if application.status == 'accepted' or application.status == 'rejected' %}bg-cyan-500{% else %}bg-gray-200{% endif %}"></div>
                        </div>
                        <div class="flex justify-between mt-2">
                            <span class="text-xs text-gray-500">Pending</span>
                            <span class="text-xs text-gray-500">Reviewed</span>
                            <span class="text-xs text-gray-500">Shortlisted</span>
                            <span class="text-xs text-gray-500">Decision</span>
                        </div>
                    </div>

                    <!-- Rejection reason -->
                    {% if application.status == 'rejected' and application.rejection_reason %}
                    <div class="mt-5 p-4 bg-red-50 border border-red-200 rounded-xl">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <div>
                                <p class="text-sm font-semibold text-red-700">Rejection Reason</p>
                                <p class="text-sm text-red-600 mt-0.5">{{ application.rejection_reason }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Reapply button -->
                    {% if application.status == 'rejected' %}
                    <a href="{% url 'apply_for_job' application.job.slug %}" class="block mt-4 text-center px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl hover:from-cyan-600 hover:to-blue-700 transition-all">
                        Reapply for this Job
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column (2/5): Application Details -->
            <div class="lg:col-span-2 flex flex-col gap-6">

                <!-- Applicant Info -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Applicant</h3>
                    <div class="info-row">
                        <span class="label">Name</span>
                        <span class="value">{{ application.full_name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Contact</span>
                        <span class="value">{{ application.contact_number }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Passport No.</span>
                        <span class="value">{{ application.passport_number }}</span>
                    </div>
                </div>

                <!-- Skills -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Skills</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for skill in application.skills.all %}
                        <span class="px-3 py-1 bg-cyan-50 text-cyan-700 text-sm font-medium rounded-full border border-cyan-200">
                            {{ skill.name }}
                        </span>
                        {% empty %}
                        <span class="text-sm text-gray-400">No skills listed</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Documents -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Documents</h3>

                    <!-- Passport Photo -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">Passport Photo</p>
                        {% if application.passport_photo %}
                        <button type="button" onclick="document.getElementById('passportModal').classList.remove('hidden')" class="w-20 h-16 rounded-lg overflow-hidden border border-gray-200 hover:ring-2 hover:ring-cyan-400 transition-all cursor-pointer">
                            <img src="{{ application.passport_photo.url }}" alt="Passport photo" class="w-full h-full object-cover">
                        </button>
                        <!-- Modal -->
                        <div id="passportModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm" onclick="this.classList.add('hidden')">
                            <div class="relative max-w-lg w-full mx-4" onclick="event.stopPropagation()">
                                <button type="button" onclick="document.getElementById('passportModal').classList.add('hidden')" class="absolute -top-3 -right-3 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-gray-900 z-10">&times;</button>
                                <img src="{{ application.passport_photo.url }}" alt="Passport photo" class="w-full rounded-xl shadow-xl">
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1.5">Click to view full size</p>
                        {% else %}
                        <p class="text-sm text-gray-400">Not uploaded</p>
                        {% endif %}
                    </div>

                    <!-- CV -->
                    <div>
                        <p class="text-sm text-gray-500 mb-2">CV / Resume</p>
                        {% if application.cv %}
                        <a href="{{ application.cv.url }}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-sm text-green-700 font-medium">Download CV</span>
                        </a>
                        {% else %}
                        <p class="text-sm text-gray-400">Not uploaded</p>
                        {% endif %}
                    </div>
                </div>

                <!-- View Job Link -->
                <a href="{% url 'user_job_detail' application.job.slug %}" class="block text-center px-4 py-3 bg-white border-2 border-gray-200 text-gray-700 font-semibold rounded-xl hover:border-cyan-400 hover:text-cyan-600 transition-all">
                    View Job Listing
                </a>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Force navbar into light mode on inner pages
    const navbar = document.getElementById('navbar');
    if (navbar) {
        navbar.classList.add('bg-white', 'shadow-sm');
        navbar.classList.remove('bg-slate-900/90', 'backdrop-blur-lg');
        navbar.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('text-white', 'hover:text-cyan-300');
            link.classList.add('text-gray-700', 'hover:text-cyan-500');
        });
        const logoText = navbar.querySelector('.nav-logo-text');
        if (logoText) { logoText.classList.remove('text-white'); logoText.classList.add('text-gray-900'); }
        const mobileBtn = navbar.querySelector('.nav-mobile-btn');
        if (mobileBtn) { mobileBtn.classList.remove('text-white', 'hover:bg-white/10'); mobileBtn.classList.add('text-gray-700', 'hover:bg-gray-100'); }
        const userName = navbar.querySelector('.nav-user-name');
        if (userName) { userName.classList.remove('text-white'); userName.classList.add('text-gray-700'); }
        const userChevron = navbar.querySelector('.nav-user-chevron');
        if (userChevron) { userChevron.classList.remove('text-white'); userChevron.classList.add('text-gray-700'); }
    }
</script>
{% endblock %}
