{% extends 'user/base.html' %}

{% block title %}Apply for {{ job.title }} - Talent Solutions{% endblock %}

{% block body_class %}bg-gray-50{% endblock %}
{% block main_class %}pt-20{% endblock %}

{% block extra_css %}
<style>
    .apply-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
    }

    .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f9fafb;
    }

    .input-field:focus {
        outline: none;
        border-color: #0ea5e9;
        background: white;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .file-upload {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload:hover {
        border-color: #0ea5e9;
        background: #f0f9ff;
    }

    .file-upload.has-file {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .file-upload.rejected {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .file-upload input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .skill-checkbox {
        display: none;
    }

    .skill-label {
        display: inline-flex;
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        background: white;
    }

    .skill-label:hover {
        border-color: #0ea5e9;
        background: #f0f9ff;
    }

    .skill-checkbox:checked + .skill-label {
        border-color: #0ea5e9;
        background: #0ea5e9;
        color: white;
    }

    .btn-submit {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 50%, #3b82f6 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
    }

    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<section class="bg-white border-b border-gray-100">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <nav class="flex items-center gap-2 text-sm text-gray-500">
            <a href="{% url 'home' %}" class="hover:text-cyan-600 transition-colors">Home</a>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <a href="{% url 'user_jobs_list' %}" class="hover:text-cyan-600 transition-colors">Jobs</a>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <a href="{% url 'user_job_detail' job.slug %}" class="hover:text-cyan-600 transition-colors truncate">{{ job.title }}</a>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span class="text-gray-900 font-medium">Apply</span>
        </nav>
    </div>
</section>

<!-- Application Form -->
<section class="py-8 sm:py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Job Summary Card -->
        <div class="bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl p-6 mb-8 text-white">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="flex-1">
                    <h1 class="text-xl sm:text-2xl font-bold mb-1">{{ job.title }}</h1>
                    <p class="text-cyan-100">{{ job.company_name }} &bull; {{ job.get_country_display_name }}</p>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold">{{ job.get_salary_display }}</p>
                    <p class="text-cyan-100 text-sm">per month</p>
                </div>
            </div>
        </div>

        <!-- Application Form Card -->
        <div class="apply-card p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Apply for this position</h2>
            <p class="text-gray-500 mb-8">Fill in your details below. Fields marked with <span class="text-red-500">*</span> are required.</p>

            <form method="POST" enctype="multipart/form-data" id="applicationForm">
                {% csrf_token %}

                <!-- Personal Information -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Personal Information
                    </h3>

                    <div class="grid sm:grid-cols-2 gap-4">
                        <!-- Full Name -->
                        <div>
                            <label for="full_name" class="block text-sm font-medium text-gray-700 mb-2">
                                Full Name <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="full_name"
                                name="full_name"
                                class="input-field"
                                placeholder="Enter your full name"
                                value="{{ form_data.full_name|default:'' }}"
                                required
                            >
                        </div>

                        <!-- Contact Number -->
                        <div>
                            <label for="contact_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Contact Number <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="tel"
                                id="contact_number"
                                name="contact_number"
                                class="input-field"
                                placeholder="+977-9800000000"
                                value="{{ form_data.contact_number|default:'' }}"
                                required
                            >
                        </div>
                    </div>
                </div>

                <!-- Passport Information -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/>
                        </svg>
                        Passport Information
                    </h3>

                    <div class="grid sm:grid-cols-2 gap-4">
                        <!-- Passport Number -->
                        <div>
                            <label for="passport_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Passport Number <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="passport_number"
                                name="passport_number"
                                class="input-field"
                                placeholder="Enter passport number"
                                value="{{ form_data.passport_number|default:'' }}"
                                required
                            >
                        </div>

                        <!-- Passport Photo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Passport Photo <span class="text-red-500">*</span>
                                <span class="text-xs text-gray-400 font-normal">(Photo of your passport)</span>
                            </label>
                            {% if rejection_reason %}
                            <div class="mb-2 p-3 bg-red-50 border border-red-300 rounded-lg flex items-start gap-2">
                                <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div>
                                    <p class="text-sm text-red-700 font-medium">Previous application was rejected</p>
                                    <p class="text-xs text-red-600 mt-0.5">{{ rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}
                            {% if existing_passport_photo %}
                            <div class="mb-2 p-2 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
                                <button type="button" onclick="document.getElementById('photoModal').classList.remove('hidden')" class="w-16 h-16 rounded overflow-hidden border border-green-300 hover:ring-2 hover:ring-cyan-400 transition-all flex-shrink-0 cursor-pointer">
                                    <img src="{{ existing_passport_photo.url }}" alt="Saved passport photo" class="w-full h-full object-cover">
                                </button>
                                <div>
                                    <p class="text-sm text-green-700 font-medium">Passport photo on file</p>
                                    <p class="text-xs text-gray-500">Click photo to view &bull; Upload a new one to replace</p>
                                </div>
                            </div>

                            <!-- Full photo modal -->
                            <div id="photoModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm" onclick="this.classList.add('hidden')">
                                <div class="relative max-w-lg w-full mx-4" onclick="event.stopPropagation()">
                                    <button type="button" onclick="document.getElementById('photoModal').classList.add('hidden')" class="absolute -top-3 -right-3 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-gray-900 z-10">&times;</button>
                                    <img src="{{ existing_passport_photo.url }}" alt="Passport photo" class="w-full rounded-xl shadow-xl">
                                </div>
                            </div>
                            {% endif %}
                            <div class="file-upload {% if rejection_reason %}rejected{% elif existing_passport_photo %}has-file{% endif %}" id="passportPhotoUpload">
                                <input type="file" name="passport_photo" id="passport_photo" accept="image/jpeg,image/png,image/jpg" {% if not existing_passport_photo %}required{% endif %}>
                                <div id="passportPlaceholder">
                                    <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-sm text-gray-500">{% if existing_passport_photo %}Upload new photo{% else %}Click to upload photo{% endif %}</p>
                                    <p class="text-xs text-gray-400 mt-1">JPG or PNG, max 5MB</p>
                                </div>
                                <div id="passportPreview" class="hidden flex flex-col items-center">
                                    <img id="passportPreviewImg" src="" alt="Preview" class="w-28 h-20 object-cover rounded-lg border border-green-300">
                                    <p class="text-xs text-green-600 font-semibold mt-2">Photo uploaded</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        Skills <span class="text-red-500">*</span>
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">Select all skills that apply to you</p>

                    <div class="flex flex-wrap gap-2">
                        {% for skill in skills %}
                        <div>
                            <input
                                type="checkbox"
                                name="skills"
                                value="{{ skill.id }}"
                                id="skill_{{ skill.id }}"
                                class="skill-checkbox"
                                {% if skill.id|stringformat:"s" in form_data.selected_skills %}checked{% endif %}
                            >
                            <label for="skill_{{ skill.id }}" class="skill-label">{{ skill.name }}</label>
                        </div>
                        {% empty %}
                        <p class="text-gray-500">No skills available</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- CV Upload (Optional) -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        CV / Resume <span class="text-gray-400 text-sm font-normal">(Optional)</span>
                    </h3>

                    {% if existing_cv %}
                    <div class="mb-2 p-2 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-green-700 font-medium">CV on file</p>
                            <p class="text-xs text-gray-500">Upload a new one to replace</p>
                        </div>
                    </div>
                    {% endif %}
                    <div class="file-upload {% if existing_cv %}has-file{% endif %}" id="cvUpload">
                        <input type="file" name="cv" id="cv" accept=".pdf,.doc,.docx">
                        <div id="cvPlaceholder">
                            <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-sm text-gray-500">{% if existing_cv %}Upload new CV{% else %}Click to upload your CV{% endif %}</p>
                            <p class="text-xs text-gray-400 mt-1">PDF or Word document, max 10MB</p>
                        </div>
                        <div id="cvPreview" class="hidden flex flex-col items-center">
                            <div class="w-10 h-12 bg-green-100 border border-green-300 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <p id="cvPreviewName" class="text-xs text-green-600 font-semibold mt-2 truncate max-w-[140px]">document.pdf</p>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-submit" id="submitBtn">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        Submit Application
                    </span>
                </button>

                <p class="text-center text-sm text-gray-500 mt-4">
                    By submitting, you agree to our
                    <a href="#" class="text-cyan-600 hover:underline">Terms of Service</a> and
                    <a href="#" class="text-cyan-600 hover:underline">Privacy Policy</a>
                </p>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Force navbar into light mode on inner pages
    const navbar = document.getElementById('navbar');
    if (navbar) {
        navbar.classList.add('bg-white', 'shadow-sm');
        navbar.classList.remove('bg-slate-900/90', 'backdrop-blur-lg');
        navbar.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('text-white', 'hover:text-cyan-300');
            link.classList.add('text-gray-700', 'hover:text-cyan-500');
        });
        const logoText = navbar.querySelector('.nav-logo-text');
        if (logoText) { logoText.classList.remove('text-white'); logoText.classList.add('text-gray-900'); }
        const mobileBtn = navbar.querySelector('.nav-mobile-btn');
        if (mobileBtn) { mobileBtn.classList.remove('text-white', 'hover:bg-white/10'); mobileBtn.classList.add('text-gray-700', 'hover:bg-gray-100'); }
        const userName = navbar.querySelector('.nav-user-name');
        if (userName) { userName.classList.remove('text-white'); userName.classList.add('text-gray-700'); }
        const userChevron = navbar.querySelector('.nav-user-chevron');
        if (userChevron) { userChevron.classList.remove('text-white'); userChevron.classList.add('text-gray-700'); }
    }

    // Passport photo — image thumbnail preview on select
    document.getElementById('passport_photo').addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('passportPreviewImg').src = e.target.result;
                document.getElementById('passportPlaceholder').classList.add('hidden');
                document.getElementById('passportPreview').classList.remove('hidden');
                document.getElementById('passportPhotoUpload').classList.add('has-file');
                document.getElementById('passportPhotoUpload').classList.remove('rejected');
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    // CV — doc icon + filename preview on select
    document.getElementById('cv').addEventListener('change', function() {
        if (this.files && this.files[0]) {
            document.getElementById('cvPreviewName').textContent = this.files[0].name;
            document.getElementById('cvPlaceholder').classList.add('hidden');
            document.getElementById('cvPreview').classList.remove('hidden');
            document.getElementById('cvUpload').classList.add('has-file');
        }
    });

    // Form submission
    document.getElementById('applicationForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Submitting...</span>';
    });
</script>
{% endblock %}
